name: Merge All Dependabot PRs

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: 'é€‰æ‹©è¦åˆå¹¶çš„æ›´æ–°ç±»å‹'
        required: true
        default: 'patch-and-minor'
        type: choice
        options:
          - 'patch-only'
          - 'patch-and-minor'
          - 'all'

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-dependabot-prs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get all Dependabot PRs
        id: get-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          prs=$(gh pr list --author "app/dependabot" --json number,title,url --limit 100)
          echo "prs<<EOF" >> $GITHUB_OUTPUT
          echo "$prs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°çš„ Dependabot PR:"
          echo "$prs" | jq -r '.[] | "\(.number): \(.title)"'

      - name: Merge Dependabot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPDATE_TYPE: ${{ inputs.update_type }}
        run: |
          echo '${{ steps.get-prs.outputs.prs }}' | jq -r '.[].number' | while read pr_number; do
            if [ -z "$pr_number" ]; then
              continue
            fi
            
            echo "æ­£åœ¨å¤„ç† PR #$pr_number"
            
            # è·å– PR æ ‡é¢˜
            pr_title=$(gh pr view $pr_number --json title --jq '.title')
            echo "PR æ ‡é¢˜: $pr_title"
            
            should_merge=false
            
            # æ ¹æ®æ›´æ–°ç±»å‹åˆ¤æ–­æ˜¯å¦åˆå¹¶
            if [ "$UPDATE_TYPE" = "all" ]; then
              should_merge=true
              echo "âœ… æ¨¡å¼: åˆå¹¶æ‰€æœ‰æ›´æ–°"
            elif [ "$UPDATE_TYPE" = "patch-only" ]; then
              # æ£€æŸ¥æ˜¯å¦åŒ…å« patch å…³é”®è¯æˆ–ç‰ˆæœ¬å·æ¨¡å¼
              if echo "$pr_title" | grep -qiE "(patch|[0-9]+\.[0-9]+\.[0-9]+)"; then
                should_merge=true
                echo "âœ… æ£€æµ‹åˆ° patch æ›´æ–°"
              fi
            elif [ "$UPDATE_TYPE" = "patch-and-minor" ]; then
              # æ’é™¤ major æ›´æ–°
              if ! echo "$pr_title" | grep -qiE "(major|breaking)"; then
                should_merge=true
                echo "âœ… æ£€æµ‹åˆ° patch æˆ– minor æ›´æ–°"
              fi
            fi
            
            # æ‰§è¡Œåˆå¹¶
            if [ "$should_merge" = true ]; then
              echo "ğŸ”„ å®¡æ‰¹å¹¶åˆå¹¶ PR #$pr_number"
              gh pr review $pr_number --approve || echo "âš ï¸ å®¡æ‰¹å¤±è´¥ï¼Œå¯èƒ½å·²å®¡æ‰¹"
              gh pr merge $pr_number --squash --auto || echo "âš ï¸ PR #$pr_number æ— æ³•è‡ªåŠ¨åˆå¹¶ï¼ˆå¯èƒ½æœ‰å†²çªï¼‰"
              echo "---"
            else
              echo "â­ï¸ è·³è¿‡ PR #$pr_number (ä¸ç¬¦åˆåˆå¹¶æ¡ä»¶)"
              echo "---"
            fi
          done
          
          echo "âœ… æ‰¹é‡åˆå¹¶å®Œæˆï¼"

      - name: Summary
        run: |
          echo "### æ‰¹é‡åˆå¹¶ç»“æœ ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- åˆå¹¶ç­–ç•¥: ${{ inputs.update_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- å·²å¤„ç†çš„ PR æ•°é‡: $(gh pr list --author 'app/dependabot' --state merged --limit 100 --json number | jq '. | length')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹æ‰€æœ‰ Dependabot PR: https://github.com/${{ github.repository }}/pulls?q=is%3Apr+author%3Aapp%2Fdependabot" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
